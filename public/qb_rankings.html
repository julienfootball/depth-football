<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QB Rankings</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        #rankings-container {
            display: flex;
            align-items: flex-start;
        }
        #numbered-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 5%;
            text-align: right;
            padding-right: 10px;
        }
        #rankings {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 95%;
            table-layout: fixed;
        }
        #rankings li, #numbered-list li {
            margin: 2px 0;
            padding: 8px;
            font-size: 1.2em;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        #rankings li {
            cursor: move;
        }
        .name {
            width: 30%;
        }
        .team, .opponent, .position, .projected_points {
            width: 15%;
            text-align: center;
        }
        button {
            margin-top: 10px;
        }
        .header {
            font-weight: bold;
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <h1>My QB Rankings</h1>
    <button onclick="window.location.href='/'">Back</button>
    <button id="save-rankings">Save Rankings</button>
    <div id="rankings-container">
        <ul id="numbered-list">
            <li class="header">#</li>
        </ul>
        <ul id="rankings">
            <li class="header">
                <span class="name">Name</span>
                <span class="team">Team</span>
                <span class="opponent">Opponent</span>
                <span class="position">Position</span>
                <span class="projected_points">Projected Points</span>
            </li>
        </ul>
    </div>

    <script>
        $(document).ready(function () {
            // Make the rankings list sortable
            $('#rankings').sortable({
                update: function(event, ui) {
                    updateNumberedList();
                }
            });
            $('#rankings').disableSelection();

            // Fetch the current rankings or default player data
            $.get('/get-rankings', function (data) {
                let rankings;
                try {
                    rankings = JSON.parse(data);
                } catch (e) {
                    rankings = data;
                }

                if (!rankings || rankings.length === 0) {
                    console.log('No rankings found for the user. Loading default player list.');
                    $.get('/player-data', function (playerData) {
                        populatePlayerList(playerData);
                    });
                } else {
                    populatePlayerList(rankings);
                }
            });

            // Save the rankings
            $('#save-rankings').click(function () {
                const rankings = [];
                $('#rankings li:not(.header)').each(function () {
                    rankings.push({
                        player_id: $(this).data('id'),
                        name: $(this).find('.name').text(),
                        team: $(this).find('.team').text(),
                        opponent: $(this).find('.opponent').text(),
                        position: $(this).find('.position').text(),
                        projected_points: $(this).find('.projected_points').text().split(' ')[0] // Extract the projected points part only
                    });
                });
                $.ajax({
                    url: '/save-rankings',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ rankings }),
                    success: function (response) {
                        alert('Rankings saved successfully');
                    },
                    error: function (error) {
                        alert('Error saving rankings');
                    }
                });
            });

            function populatePlayerList(players) {
                const ul = $('#rankings');
                const numberUl = $('#numbered-list');
                players.forEach((player, index) => {
                    const li = `<li data-id="${player.player_id}">
                                    <span class="name">${player.name}</span>
                                    <span class="team">${player.team}</span>
                                    <span class="opponent">${player.opponent || 'N/A'}</span>
                                    <span class="position">${player.position || 'N/A'}</span>
                                    <span class="projected_points">${player.projected_points} pts</span>
                                </li>`;
                    ul.append(li);
                    numberUl.append(`<li>${index + 1}</li>`);
                });
            }

            function updateNumberedList() {
                const numberUl = $('#numbered-list');
                numberUl.find('li:not(.header)').each(function (index) {
                    $(this).text(index + 1);
                });
            }
        });
    </script>
</body>
</html>
